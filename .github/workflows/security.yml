name: Security Scan

on:
  schedule:
    # Executar scan de segurança diariamente às 3h
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      severity:
        description: 'Severity threshold'
        required: false
        default: 'high'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical

env:
  NODE_VERSION: '18'

jobs:
  security-scan:
    name: 🔒 Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
      
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: 📦 Install dependencies
        run: npm ci
      
      - name: 🔍 Run npm audit
        run: npm audit --audit-level=${{ github.event.inputs.severity || 'high' }}
      
      - name: 🛡️ Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ github.event.inputs.severity || 'high' }}
      
      - name: 🔒 Run CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
      
      - name: 🔍 Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
      
      - name: 📊 Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            snyk.sarif
            codeql-results.sarif
          retention-days: 30
      
      - name: 🚨 Notify security issues
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: failure
          channel: '#security'
          text: '🚨 Security vulnerabilities detected!'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
